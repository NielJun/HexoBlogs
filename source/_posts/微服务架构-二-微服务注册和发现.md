---
title: ' 微服务架构 [二] 服务注册'
date: 2020-02-06 14:31:46
tags: [Go,微服务,Micro Service]
categories: Go栈
---

# 微服务架构

微服务架构

## 服务注册

以订单服务请求产品服务调用为例，一帮的服务注册可以采用两种实现方式。

### **客户端实现**

1. 需要维护所有调用服务的地址
2. 有一定的技术难度，需要rpc框架支持

当采用客户端来做的时候，结构图如下

![](/1.png)

当我们订单服务调用产品服务的时候，由于有三个产品服务，在客户端起来的时候，产品服务会把自己的ip地址等信息注册到服务注册中心里，当订单服务请求产品服务的时候，他会优先查询本地的产品服务的源信息[IP，名字等等]，若没有，则回去注册中心查询对应的服务IP列表。

得到IP列表以后，选择调用哪一个则有对应的**负载均衡**的策略。

- 轮询的负载均衡
- 通过特定映射的一致性Hash

找到以后就可以调用了。

### **服务器实现**

1. 架构简单
2. 可能会有单点故障

当采用服务器端来做的时候，结构图如下

![](/2.png)

当订单服务来调用产品服务时，已经不直接通过和注册中心联系的方式查询，而是直接调用LB来调用产品服务，这对于调用方来说是完全透明的。不需要自己实现查询这一套方案。

## 注册中心

### etcd注册中心

etcd 是一种分布式 kv 存储设施, 他具有一定的**一致性,高性能,高可用**的方案.基于raft一致性协议。类似的 zookeeper, 但没有 zookeeper 那么重型,功能也没有覆盖那么多. 简单直接的应用就是配置中心。

#### etcd使用场景

- 服务注册和发现
- 共享配置
- 分布式锁
- Leader选举

但是etcd虽然是强一致性的，当某时刻etcd的节点如果出现问题，这段时间需要选举一个新的主来，在这段时间内，我们的服务是不可用的。我们对etcd的强一致性是不需要高度一致的，比如在微服务在某时刻查询注册中心的ip列表的时候，各个查询的结果不是强一直也不会有太大影响，只要一致性存在就行。

#### 弱一致性AP系统

虽然在某时刻节点挂掉以后，不影响服务的正常运行，通过主从同步都会恢复，不需要强一致性。

#### 强一致性

Eureka是高可用的注册中心。是一个AP系统，由netflix开发。

### 分布式一致性问题

单独一个节点是不存在分布式一致性问题的，但是在集群里面，分布式一致性问题是避免不了的问题。

在一个操作中，需要多个系统之间配合才能完成的整个业务逻辑，叫做分布式系统。

#### 分布式拆分三步骤

　　1.将你的整个整个应用视为一个系统（不管它有多复杂）

　　2.将整个系统分割为一系列的服务模块， 每个服务模块完成一定的功能（单一职责）

　　3.将这些服务模块 分散部署到不同的机器上。分散后，选择若干种（没错一种可能不够）通信协议把他们连接起来，当执行某项操作的时候按照拆分的系统有序的执行。

### 拆分+连接是分布式系统的本质

　　所谓分布式，无非就是”将一个系统拆分成多个子系统并散布到不同设备“的过程而已。

　　本质上而言，实现一个分布式系统，最核心的部分无非有两点：

　　　1.如何拆分——可以有很多方式，核心依据一是业务需求，二是成本限制。这是实践中构建分布式系统时最主要的设计依据。

　　　2.如何连接——光把系统拆开成 单个服务模块还不够，关键是拆开后的 服务模块之间还要能通信，因此涉及通信协议设计的问题，需要考虑的因素很多，好消息是这部分其实成熟，方案很多。

### 为什么你要使用分布式？

　　分布式系统并非灵丹妙药，解决问题的关键还是看你对问题本身的了解。通常我们需要使用分布式的常见理由是：

　　1.为了性能扩展 ——系统负载高，单台机器无法承载，希望通过使用多台机器来提高系统的负载能力。

　　　　例：对一个B2C(京东、淘宝)商城进行拆分，首页部分我们要考虑到高并发、高可用、搜索、缓存等等一系列的情况，需要把这个功能单独拆分出来来扩展性能

 　　2.为了增强可靠性 ——软件不是完美的，网络不是完美的，甚至机器本身也不可能是完美的，随时可能会出错，为了避免故障，需要将业务分散开保留一定的冗余度

在以提供 Service 为主的服务端软件开发过程中常常遇到这些问题。

 一些分布式方案能解决你的问题，另一些却不能，要学会的其实是选择。

　　笼统的讨论分布式没有太大的意义，就如我刚才所谈的，实际上分布式很容易实现。真正难的地方在于如何选择正确的分布方案。

　　例如，当你想要建立一个分布式的数据管理系统的时候，你就必须得面对“一致性”问题。如果你对数据一致性要求很高，你就不得不容忍一些缺陷例如规模伸缩困难；而如果你放弃它，你可以轻松伸缩规模，但你必须解决好由此带来的一系列数据不一致导致的问题。（CAP 问题）

![](/3.jpg)



