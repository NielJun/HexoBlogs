---
title: 服务器平滑升级 柔性重启
date: 2020-01-25 17:19:24
tags: [Go,服务端开发]
categories: Go栈
---

# 服务器平滑升级

​		当我们的server需要进行升级的时候，我们不可能说吧正在接受和处请求的服务down掉，硬性的进行upgrade，毕竟当流量比较大的时候，这是非常不好的一种体验损失和价值的流失。

​		但我们如何在程序升级的过程中，不影响正在处理的请求呢？还有除了不影响以外，我们需要怎么去做？要是在做的过程中，系统在升级，此时新的请求进来怎么办？

## 柔性重启

- **我们如何在程序升级的过程中，不影响正在处理的请求呢？**

最简单粗暴的方式就是等待其处理完之后再进行退出。当然在1.8里面已经支持，最简单的就是在`goroutine`添加的时候添加计数。

- **还有除了不影响以外，我们需要怎么去做？**
- **要是在做的过程中，系统在升级，此时新的请求进来怎么办？**

我们可以`Fork`一个新的`子进程`，`继承`父进程监听的Socket,然后子进程启动之后接受新的连接，同时父进程停止接受新的连接，等已有的处理操作完毕后，退出。再进行升级，然后优雅重启成功

### 那按照这个思路，子进程如何继承父进程的文件句柄？

1. 通过 os.Cmd 对象中的ExtraFiles参数进行传递

   ```go
   os.Cmd
   ```

   

2. 文件句柄继承

 注:系统进程的继承**只在Linux上面有效**



